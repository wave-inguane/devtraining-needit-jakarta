<?xml version="1.0" encoding="UTF-8"?>
<record_update sys_domain="global" table="sysevent_email_action">
    <sysevent_email_action action="INSERT_OR_UPDATE">
        <action_insert>true</action_insert>
        <action_update>true</action_update>
        <active>true</active>
        <advanced_condition><![CDATA[// Advanced condition: Server-side script to determine if a notification should be generated and sent.
/*
Advanced Condition
Use a server-side script to evaluate conditions that cannot be created using the Condition field. The script has access to two global variables:

current: The target table record associated with the notification (All notifications).
event: The event object that triggered the notification (Event is fired notifications only).
The script must set the answer variable to either true or false. If there is no script, the field returns true. Both the Condition and Advanced Condition fields must return true for the notification to be sent.

This demo script retrieves the user record for the value in the Assigned to field on the NeedIt Task table.
 */
(function executeRule(current, previous /*null when async*/) {
	
	var stringBuilder = {myKey : ''};
		var answer = false;
		
		// Get the user record for the  Assigned to user form the NeedIt Task record
		var userRec = new GlideRecord('sys_user');
		userRec.addQuery('name', current.assigned_to.getDisplayValue());
		userRec.query();
		if(userRec.next()){
			// Query the sys_user_grmember to determine if the Assigned to is
			// a member of NeedIt Task Fulfiller group. If yes, set the
			// answer variable to true and send notification. If not,
			// set the answer variable to false and do not send the notification.
			
			var checkMember = new GlideRecord('sys_user_grmember');
			checkMember.addQuery('user.name', userRec.name);
			checkMember.addQuery('group.name', 'CAB Approval');
			checkMember.query();
			// db
			
			//User Icon
			stringBuilder.myKey += '<br/><span class="glyphicon glyphicon-user"></span>' +" "+userRec.name +"<br/> Group Member : CAB Approval";
			var flag = false;
			if((flag=checkMember.next())==true){// foundOne
				//db
				
				stringBuilder.myKey += '<br/>' +
				'<button type="button" class="btn btn-success btn-xs" data-toggle="tooltip" data-placement="right" title="" data-original-title="Tooltip on right">'+flag+'</button>';
				
				
			}else{
				stringBuilder.myKey += '<br/>' +
				'<button type="button" class="btn btn-danger btn-xs" data-toggle="tooltip" data-placement="right" title="" data-original-title="Tooltip on right">'+flag+'</button>';
				
			}
		}
		
		myAlert(stringBuilder, current);
	})(current, previous);
	
	/*
	stringBuilder.myKey += '<br/>' +
	'<button type="button" class="btn btn-success btn-xs" data-toggle="tooltip" data-placement="right" title="" data-original-title="Tooltip on right">'+flag+'</button>';
	
	stringBuilder.myKey += '<br/>' +
	'<button type="button" class="btn btn-danger btn-xs" data-toggle="tooltip" data-placement="right" title="" data-original-title="Tooltip on right">'+flag+'</button>';
 	*/
	function myAlert(stringBuilder, current){
		//https://bootswatch.com/default/
		gs.addInfoMessage('<div class="panel panel-warning">'+
		'<div class="panel-heading">'+
		'<h3 class="panel-title">Notification: Advanced Condition Script TEST </h3>'+
		'</div>'+
		'<div class="panel-body">'+
		'<blockquote><p><code>'+ ' code output ' +'</code>' +'<br/>'
		+stringBuilder.myKey +'<br/></p></blockquote>'+
		'</div>'+
		'</div>');
	}]]></advanced_condition>
        <affected_field_on_event/>
        <category display_value="Uncategorized">c97d83137f4432005f58108c3ffa917a</category>
        <collection>x_58872_needit_needit_task</collection>
        <condition/>
        <content_type>text/html</content_type>
        <description/>
        <event_name>approval.cancelled</event_name>
        <event_parm_1>false</event_parm_1>
        <event_parm_2>false</event_parm_2>
        <exclude_delegates>false</exclude_delegates>
        <force_delivery>false</force_delivery>
        <from/>
        <generation_type>engine</generation_type>
        <importance/>
        <include_attachments>false</include_attachments>
        <item>event.parm1</item>
        <item_table/>
        <mandatory>false</mandatory>
        <message/>
        <message_html/>
        <message_list/>
        <message_text/>
        <name>Overdue NeedIt Task</name>
        <omit_watermark>false</omit_watermark>
        <order>100</order>
        <push_message_only>false</push_message_only>
        <recipient_fields/>
        <recipient_groups name="CAB Approval">b85d44954a3623120004689b2d5dd60a</recipient_groups>
        <recipient_users>024714d34f6103003b564ea18110c752</recipient_users>
        <reply_to/>
        <send_self>true</send_self>
        <sms_alternate/>
        <style/>
        <subject/>
        <subscribable>false</subscribable>
        <sys_class_name>sysevent_email_action</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2017-10-15 05:24:20</sys_created_on>
        <sys_domain>global</sys_domain>
        <sys_domain_path>/</sys_domain_path>
        <sys_id>de202ff54f3183003b564ea18110c789</sys_id>
        <sys_mod_count>28</sys_mod_count>
        <sys_name>Overdue NeedIt Task</sys_name>
        <sys_overrides/>
        <sys_package display_value="NeedIt" source="x_58872_needit">6ead8e780f603200cd674f8ce1050ed1</sys_package>
        <sys_policy/>
        <sys_scope display_value="NeedIt">6ead8e780f603200cd674f8ce1050ed1</sys_scope>
        <sys_update_name>sysevent_email_action_de202ff54f3183003b564ea18110c789</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2017-10-15 22:53:17</sys_updated_on>
        <sys_version>2</sys_version>
        <template display_value="Unsubscribe and Preferences">7ed0481f3b0b2200c869c2c703efc487</template>
        <type>email</type>
        <weight>0</weight>
    </sysevent_email_action>
</record_update>
